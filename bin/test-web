#!/usr/bin/env bash
set -e

export MOCK_RAYLIB=1

log() {
  echo "[ $0 ] $@"
}

log "Building Taylor"
rake linux:release:build || exit 1

log "Building docker"
bundle exec rake docker:build:export:web &> /dev/null

if [[ $? -gt 0 ]]; then
  log "Building failed"
  exit 1
fi

pushd test

log "Exporting"
rm -rf exports
mkdir -p exports
mkdir -p /tmp/taylor-builds
../dist/linux/release/taylor ../cli-tool/cli.rb export --export-targets web --build-cache /tmp/taylor-builds

if [[ $? -gt 0 ]]; then
  log "Exporting failed"
  exit 1
fi

log "Running tests"
pushd exports
unzip taylor-test-suite-web-v0.0.1.zip &> /dev/null
../../.buildkite/scripts/tests/web_test.rb
export WEB_EXIT_CODE=$?

popd
popd
exit $WEB_EXIT_CODE
