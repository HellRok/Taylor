#!/usr/bin/env bash
set -e

DIRNAME=$(dirname -- "${0}")
SCRIPT_DIR=$(cd -- "${DIRNAME}" > /dev/null 2>&1 && pwd)
source "${SCRIPT_DIR}"/shared.lib.sh

export MOCK_RAYLIB=1

log "Building Taylor"
bundle exec rake linux:release:build &> /dev/null || exit 1

log "Building docker"
bundle exec rake docker:build:export:web &> /dev/null

if [[ $? -gt 0 ]]; then
  log "Building failed"
  exit 1
fi

pushd test &> /dev/null

log "Exporting"
rm -rf exports
mkdir -p exports
mkdir -p /tmp/taylor-builds
../dist/linux/release/taylor ../cli-tool/cli.rb export --export-targets web --build-cache /tmp/taylor-builds &> /dev/null

if [[ $? -gt 0 ]]; then
  log "Exporting failed"
  exit 1
fi

log "Running tests"
pushd exports &> /dev/null
unzip taylor-test-suite-web-v0.0.1.zip &> /dev/null
../../.buildkite/scripts/tests/web_test.rb
