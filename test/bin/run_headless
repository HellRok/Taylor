#!/usr/bin/env bash
set -u

export DISPLAY=:1

rake linux:build windows:build || exit 1

pushd test/

../dist/linux/debug/taylor ../cli-tool/cli.rb test.rb 2> /dev/null
export NATIVE_EXIT_CODE=$?

if [[ NATIVE_EXIT_CODE -gt 0 ]]; then
  echo "Linux: $NATIVE_EXIT_CODE"
  exit $NATIVE_EXIT_CODE
fi

wine ../dist/windows/debug/taylor.exe ../cli-tool/cli.rb test.rb 2> /dev/null
export WINE_EXIT_CODE=$?

echo "Linux: $NATIVE_EXIT_CODE"
echo "Wine:  $WINE_EXIT_CODE"

popd
exit $NATIVE_EXIT_CODE || $WINE_EXIT_CODE
