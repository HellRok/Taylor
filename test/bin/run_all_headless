#!/usr/bin/env bash

export MOCK_RAYLIB=1

log() {
  echo "[ $0 ] $@"
}

log "Building binaries"
bundle exec rake linux:build linux:release:build windows:release:build &> /dev/null


if [[ $? -gt 0 ]]; then
  log "Building failed"
  exit 1
fi

log "Building docker"
bundle exec rake docker:build:all &> /dev/null

if [[ $? -gt 0 ]]; then
  log "Building failed"
  exit 1
fi

rm -rf exports
mkdir -p exports
log Exporting
mkdir -p /tmp/blah
taylor-dev export --export-targets web --build-cache /tmp/blah &> /dev/null

if [[ $? -gt 0 ]]; then
  log "Exporting failed"
  exit 1
fi

../dist/linux/release/taylor ../cli-tool/cli.rb test.rb
export NATIVE_EXIT_CODE=$?
wine ../dist/windows/release/taylor.exe ../cli-tool/cli.rb test.rb 2> /dev/null
export WINE_EXIT_CODE=$?

pushd exports
unzip taylor-test-suite-web-v0.0.1.zip &> /dev/null
../../.buildkite/scripts/tests/web_test.rb
export WEB_EXIT_CODE=$?

popd

log "Linux: $NATIVE_EXIT_CODE"
log "Wine:  $WINE_EXIT_CODE"
log "Web:   $WEB_EXIT_CODE"

exit $NATIVE_EXIT_CODE || $WINE_EXIT_CODE || $WEB_EXIT_CODE
